<!--
@name api-test.html
@url /api-test
@author Wispy Core Team
@layout default
@is_draft false
@require_auth false
@required_roles []
-->
{{define "page-content"}}
<div class="container mx-auto px-4 py-8">
    <div class="prose max-w-4xl mx-auto">
        <h1>API Template Function Test Suite</h1>
        <p>This page demonstrates the enhanced API template function with improved error handling and helper functions.</p>
        
        <div class="alert alert-info">
            <svg class="w-6 h-6 stroke-current shrink-0" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span>All API calls are made server-side during template rendering. <a href="/api-docs" class="link">View full documentation</a></span>
        </div>

        <h2>Test 1: Basic API Call with Error Handling</h2>
        <div class="mockup-code">
            <pre><code>{{ `{{ $pages := api "GET" "/admin/api/v1/pages?site=localhost" }}
{{ if isAPIError $pages }}
    Error: {{ getAPIError $pages }}
{{ else if isAPISuccess $pages }}
    Success! Found data.
{{ end }}` }}</code></pre>
        </div>
        
        {{ $pages := api "GET" "/admin/api/v1/pages?site=localhost" }}
        
        <div class="alert {{ if isAPIError $pages }}alert-error{{ else if isAPISuccess $pages }}alert-success{{ else }}alert-warning{{ end }}">
            <h3>API Response Status:</h3>
            <div class="bg-base-200 p-4 rounded mt-2">
                {{ if isAPIError $pages }}
                    <strong>‚ùå Error:</strong> {{ getAPIError $pages }}<br>
                    {{ if $pages._debug }}<strong>Debug:</strong> {{ $pages._debug }}{{ end }}
                {{ else if isAPISuccess $pages }}
                    <strong>‚úÖ Success!</strong> API call completed successfully<br>
                    <strong>Response Type:</strong> {{ printf "%T" $pages }}<br>
                    {{ if $pages.data }}
                        <strong>Data Count:</strong> {{ len $pages.data }} items
                    {{ end }}
                {{ else }}
                    <strong>‚ö†Ô∏è Unknown Status</strong>
                {{ end }}
            </div>
        </div>

        <h2>Test 2: Health Check with Helper Functions</h2>
        <div class="mockup-code">
            <pre><code>{{ `{{ $health := api "GET" "/health" }}
{{ $status := getAPIData $health "status" }}` }}</code></pre>
        </div>
        
        {{ $health := api "GET" "/health" }}
        {{ $status := getAPIData $health "status" }}
        
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-title">Health Check</div>
                <div class="stat-value {{ if isAPISuccess $health }}text-success{{ else }}text-error{{ end }}">
                    {{ if isAPIError $health }}
                        ‚ùå Failed
                    {{ else }}
                        ‚úÖ {{ default "OK" $status }}
                    {{ end }}
                </div>
                <div class="stat-desc">
                    {{ if isAPIError $health }}
                        {{ getAPIError $health }}
                    {{ else }}
                        Status Code: {{ $health.status_code }}
                    {{ end }}
                </div>
            </div>
        </div>

        <h2>Test 3: Invalid Endpoint (Error Testing)</h2>
        <div class="mockup-code">
            <pre><code>{{ `{{ $invalid := api "GET" "/invalid/endpoint" }}` }}</code></pre>
        </div>
        
        {{ $invalid := api "GET" "/invalid/endpoint" }}
        
        <div class="alert alert-error">
            <h3>Expected Error Response:</h3>
            <div class="bg-base-200 p-4 rounded mt-2">
                <strong>Is Error:</strong> {{ isAPIError $invalid }}<br>
                <strong>Error Message:</strong> {{ getAPIError $invalid }}<br>
                <strong>Status Code:</strong> {{ $invalid.status_code }}<br>
                {{ if $invalid._debug }}<strong>Debug Info:</strong> {{ $invalid._debug }}{{ end }}
            </div>
        </div>

        <h2>Test 4: Input Validation Testing</h2>
        <div class="mockup-code">
            <pre><code>{{ `{{ $invalidMethod := api "" "/health" }}
{{ $invalidPath := api "GET" "" }}` }}</code></pre>
        </div>
        
        {{ $invalidMethod := api "" "/health" }}
        {{ $invalidPath := api "GET" "" }}
        
        <div class="grid md:grid-cols-2 gap-4">
            <div class="card bg-base-200">
                <div class="card-body">
                    <h3 class="card-title">Empty Method Test</h3>
                    <p><strong>Error:</strong> {{ getAPIError $invalidMethod }}</p>
                    {{ if $invalidMethod._debug }}<p><strong>Debug:</strong> {{ $invalidMethod._debug }}</p>{{ end }}
                </div>
            </div>
            
            <div class="card bg-base-200">
                <div class="card-body">
                    <h3 class="card-title">Empty Path Test</h3>
                    <p><strong>Error:</strong> {{ getAPIError $invalidPath }}</p>
                    {{ if $invalidPath._debug }}<p><strong>Debug:</strong> {{ $invalidPath._debug }}</p>{{ end }}
                </div>
            </div>
        </div>

        <h2>Test 5: JSON Helper Functions</h2>
        <div class="mockup-code">
            <pre><code>{{ `{{ $data := dict "name" "Test" "count" 42 }}
{{ $json := toJSON $data }}
{{ $parsed := fromJSON $json }}` }}</code></pre>
        </div>
        
        {{ $data := dict "name" "Test" "count" 42 }}
        {{ $json := toJSON $data }}
        {{ $parsed := fromJSON $json }}
        
        <div class="overflow-x-auto">
            <table class="table table-zebra">
                <thead>
                    <tr>
                        <th>Operation</th>
                        <th>Input</th>
                        <th>Output</th>
                        <th>Type</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Original Data</td>
                        <td>{{ printf "%v" $data }}</td>
                        <td>{{ printf "%v" $data }}</td>
                        <td>{{ printf "%T" $data }}</td>
                    </tr>
                    <tr>
                        <td>To JSON</td>
                        <td>{{ printf "%v" $data }}</td>
                        <td>{{ $json }}</td>
                        <td>{{ printf "%T" $json }}</td>
                    </tr>
                    <tr>
                        <td>From JSON</td>
                        <td>{{ $json }}</td>
                        <td>{{ printf "%v" $parsed }}</td>
                        <td>{{ printf "%T" $parsed }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h2>Test 6: Advanced Body Handling</h2>
        <div class="mockup-code">
            <pre><code>{{ `{{ $postTest := api "POST" "/admin/api/v1/pages" (dict 
    "headers" (dict "Content-Type" "application/json")
    "body" (dict 
        "title" "Test Page from Template"
        "content" "Generated by API template function"
        "metadata" (dict "test" true "timestamp" "2025-06-06")
    )
) }}` }}</code></pre>
        </div>
        
        {{ $postTest := api "POST" "/admin/api/v1/pages" (dict 
            "headers" (dict "Content-Type" "application/json")
            "body" (dict 
                "title" "Test Page from Template"
                "content" "Generated by API template function"
                "metadata" (dict "test" true "timestamp" "2025-06-06")
            )
        ) }}
        
        <div class="alert {{ if isAPIError $postTest }}alert-warning{{ else }}alert-info{{ end }}">
            <h3>POST Request Result:</h3>
            <div class="bg-base-200 p-4 rounded mt-2">
                {{ if isAPIError $postTest }}
                    <strong>Expected Error (no write access):</strong> {{ getAPIError $postTest }}
                {{ else }}
                    <strong>Success:</strong> Page creation request processed<br>
                    <strong>Response:</strong> <pre>{{ toJSON $postTest }}</pre>
                {{ end }}
                {{ if $postTest._validation_warnings }}
                    <strong>Validation Warnings:</strong>
                    <ul>
                        {{ range $postTest._validation_warnings }}
                            <li>{{ . }}</li>
                        {{ end }}
                    </ul>
                {{ end }}
            </div>
        </div>

        <div class="divider"></div>
        
        <h2>Performance & Debug Information</h2>
        <div class="stats stats-vertical lg:stats-horizontal shadow">
            <div class="stat">
                <div class="stat-title">Total API Calls</div>
                <div class="stat-value">7</div>
                <div class="stat-desc">Made during page render</div>
            </div>
            
            <div class="stat">
                <div class="stat-title">Error Handling</div>
                <div class="stat-value text-success">‚úÖ</div>
                <div class="stat-desc">Comprehensive validation</div>
            </div>
            
            <div class="stat">
                <div class="stat-title">Context Forwarding</div>
                <div class="stat-value text-success">‚úÖ</div>
                <div class="stat-desc">Auth & session preserved</div>
            </div>
        </div>

        <div class="text-center mt-8">
            <a href="/api-docs" class="btn btn-primary">üìö View Full Documentation</a>
            <a href="/" class="btn btn-outline">üè† Back to Home</a>
        </div>
    </div>
</div>
{{end}}
